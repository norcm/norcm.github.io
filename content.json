[{"title":"V2ray 快速搭建和配置","date":"2019-05-25T09:48:40.000Z","path":"2019/05/25/v2ray/","content":"<h1><span id=\"一-简单介绍\">一、简单介绍</span></h1><hr>\n<p><a href=\"https://www.v2ray.com\" target=\"_blank\" rel=\"noopener\">V2ray</a>是Project V下的一个工具，可以说是新一代的科学上网神器，网上对它的介绍太多了，在此就不过多赘述，相比于ShadowSocks我现在更愿意使用V2ray。<a href=\"https://toutyrater.github.io/\" target=\"_blank\" rel=\"noopener\">V2ray配置指南</a>这个博客也有比较小白的教学，但是这些教学在使用前都还得学习一下v2ray的配置，本文的目的是将配好的配置给出来，这样可以直接复制粘贴就可以使用(所以配置不多，仅包含常用和实用的)。</p>\n<p>我自己搭建的服务，在自己网络带宽允许的情况下，看油管4K视频没有压力！！ YouTube 4K视频下载速度SS与V2ray对比:</p>\n<a id=\"more\"></a>\n<p><img src=\"/2019/05/25/v2ray/ss_speed.png\" alt=\"ss_speed.png\"> <img src=\"/2019/05/25/v2ray/v2ray_speed.png\" alt=\"v2ray_speed.png\"></p>\n<h1><span id=\"二-服务器准备\">二、服务器准备</span></h1><hr>\n<p>我使用的是Google Cloud Platform的机器，主要是因为他是免费哒，只需要准备一张VISA卡就可以啦(不要跟我说它只免费一年，你还是太年轻)。<br>下面是我服务器的配置，其他平台的也大同小异，主要是系统选择Debian9就可以了：</p>\n<ol>\n<li>地区选最好选香港(创建的时候有可能会没有资源了，就换成台湾)。</li>\n<li>机器配置就选g1-small</li>\n<li>启动磁盘默认的Debian9即可</li>\n<li>防火墙勾选允许 HTTP 流量，允许 HTTPS 流量</li>\n<li>还要注意有些平台像GCP，端口都是被防火墙拦截了的，需要额外配置防火墙规则<br><img src=\"/2019/05/25/v2ray/gcp_vm_config.png\" alt=\"gcp_vm_config.png\"></li>\n</ol>\n<h1><span id=\"三-搭建\">三、搭建</span></h1><h2><span id=\"1静态ip与防火墙规则\">1.静态IP与防火墙规则</span></h2><p>GCP的服务器需要先申请一个固定的静态外网IP地址，创建完虚拟机时会给一个临时的外网IP地址，这个地址会在机器重启时变化，虽然一般情况下都不会去重启机器，但保险起见还是需要一个固定的IP。先在VPC网络的外部IP地址里添加一个静态IP并挂接到虚拟机。</p>\n<p><img src=\"/2019/05/25/v2ray/static_ip.png\" alt=\"static_ip.png\"><br><img src=\"/2019/05/25/v2ray/static_ip_change_ce.png\" alt=\"static_ip_change_ce.png\"></p>\n<p>防火墙放行所有端口，在VPC网络的防火墙规则里添加两条规则，一条出站，一条入站。</p>\n<p><img src=\"/2019/05/25/v2ray/iptable_new.png\" alt=\"iptable_new.png\"><br><img src=\"/2019/05/25/v2ray/iptable_entry_config.png\" alt=\"iptable_entry_config.png\"><br><img src=\"/2019/05/25/v2ray/iptable_out_config.png\" alt=\"iptable_out_config.png\"></p>\n<h2><span id=\"2服务器环境\">2.服务器环境</span></h2><h3><span id=\"1时区\">1)时区</span></h3><p>通过SSH连接到服务器，可以直接点解VM实例的SSH连接，也可以配置SSH秘钥然后通过XShell等工具连接。下面所有的操作都要在root用户下进行，执行<code>sudo -i</code>切换到root用户。</p>\n<p>v2ray依赖时间进行校验连接,开始前需要确认服务器时间,与本地时间不能相差超过90秒，执行 <code>date -R</code>命令查看服务器时间：<br><img src=\"/2019/05/25/v2ray/new_vm_date.png\" alt=\"new_vm_date.png\"><br>这个时间明显不对，需要更换时区。执行<code>tzselect</code>选择时区，选择 Asia-&gt;China-&gt;Beijing:</p>\n<p><img src=\"/2019/05/25/v2ray/tzselect.png\" alt=\"tzselect.png\"></p>\n<p>执行下面命令<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"Asia/Shanghai\"</span> &gt; /etc/timezone</span><br><span class=\"line\"><span class=\"comment\"># 设置环境变量</span></span><br><span class=\"line\">cat &gt;&gt; ~/.profile &lt;&lt; EOF</span><br><span class=\"line\"><span class=\"built_in\">export</span> TZ=<span class=\"string\">'Asia/Shanghai'</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"comment\"># 使修改生效</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> ~/.profile</span><br></pre></td></tr></table></figure></p>\n<p>再来查看时间是否正确</p>\n<p><img src=\"/2019/05/25/v2ray/right_vm_date.png\" alt=\"right_vm_date.png\"></p>\n<h3><span id=\"2bbr加速\">2)BBR加速</span></h3><p>BBR是一个google开源的TCP拥塞控制算法，使用了这个以后我们的上网速度会有极大的提升。执行以下命令：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget --no-check-certificate https://github.com/teddysun/across/raw/master/bbr.sh</span><br><span class=\"line\">chmod +x bbr.sh</span><br><span class=\"line\"><span class=\"comment\"># 按照提示直接回车即可</span></span><br><span class=\"line\">./bbr.sh</span><br><span class=\"line\"><span class=\"comment\"># 查看是否成功</span></span><br><span class=\"line\">sysctl net.ipv4.tcp_congestion_control</span><br><span class=\"line\"><span class=\"comment\"># 应该返回:net.ipv4.tcp_congestion_control = bbr</span></span><br></pre></td></tr></table></figure></p>\n<h2><span id=\"3安装v2ray服务\">3.安装V2ray服务</span></h2><p>执行以下命令：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://install.direct/go.sh</span><br><span class=\"line\">chmod +x go.sh</span><br><span class=\"line\"><span class=\"comment\"># 执行后稍微等待下就可以了</span></span><br><span class=\"line\">./go.sh</span><br></pre></td></tr></table></figure></p>\n<p>将v2ray的执行文件路径添加到环境变量：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt;/etc/profile&lt;&lt;EOF </span><br><span class=\"line\"><span class=\"built_in\">export</span> V2RAY_BIN=/usr/bin/v2ray</span><br><span class=\"line\"><span class=\"built_in\">export</span> PATH=<span class=\"variable\">$PATH</span>:<span class=\"variable\">$V2RAY_BIN</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"comment\"># 使配置生效</span></span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动v2ray服务</span></span><br><span class=\"line\">systemctl start v2ray</span><br></pre></td></tr></table></figure></p>\n<h2><span id=\"4安装v2ray客户端\">4.安装V2ray客户端</span></h2><p>V2ray的客户端多种多样，<a href=\"https://www.v2ray.com/awesome/tools.html\" target=\"_blank\" rel=\"noopener\">V2ray官方文档</a>中有列举很多不错的工具。推荐Windows使用<a href=\"https://github.com/2dust/v2rayN\" target=\"_blank\" rel=\"noopener\">V2rayN</a>，Android使用<a href=\"https://github.com/2dust/v2rayNG\" target=\"_blank\" rel=\"noopener\">V2rayNG</a>，也有Mac和IOS的工具，但我不是很熟悉就不推荐了。</p>\n<h1><span id=\"四-配置\">四、配置</span></h1><p>V2ray的服务基于配置，当想要用不同的协议和方式代理时，不需要重装服务，只需要修改配置文件，然后重启服务即可。V2ray支持各种各样的配置和各种配置的组合，花样太多，我就推荐两种常用配置。<br>1.kcp+动态端口组合。kcp协议据说是比tcp快很多的一个协议，加上动态端口，可以有效的防止电信运营商的<a href=\"https://baike.baidu.com/item/QoS\" target=\"_blank\" rel=\"noopener\">QoS检测</a><br>2.WebSocket+TLS+Web。其他的各种配置相对这个组合来说都不算是安全的，有关部门和运营商可以比较轻松的识别出你的请求，在特殊时期一般配置的代理服务都有可能被封禁，但是这个配置基于https和nginx转发代理的，请求安全上更上层楼，也更加隐蔽和不易发现，但也比其他的复杂一些。<br>V2ray的配置文件路径：<code>/etc/v2ray/config.json</code>。v2ray的配置文件虽然是json格式但是它支持注解可以使用双斜杠<code>//</code></p>\n<p>配置中路径<code>inbounds.settings.client.id</code> id是UUID格式，V2rayN客户端在添加配置时可以生成UUID，也可以使用服务的命令生成<code>/usr/bin/v2ray/v2ctl uuid</code>，这个就相当于一个用户的口令了，客户端和服务端配置相同的UUID才可以正常连接。</p>\n<h2><span id=\"1kcp和动态端口\">1.kcp和动态端口</span></h2><p>将下面的json直接替换掉<code>/etc/v2ray/config.json</code>里的内容就行了。</p>\n<p>V2ray服务端的配置：<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"log\"</span>: &#123; <span class=\"comment\">// 日志</span></span><br><span class=\"line\">    <span class=\"attr\">\"loglevel\"</span>: <span class=\"string\">\"warning\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"access\"</span>: <span class=\"string\">\"/var/log/v2ray/access.log\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"error\"</span>: <span class=\"string\">\"/var/log/v2ray/error.log\"</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">\"inbounds\"</span>: [&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"port\"</span>: <span class=\"number\">8080</span>,  <span class=\"comment\">// 第一次握手端口</span></span><br><span class=\"line\">    <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"vmess\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"settings\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"clients\"</span>: [&#123;</span><br><span class=\"line\">        <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"uuid1\"</span>, <span class=\"comment\">// 客户端的uuid 可配置多个</span></span><br><span class=\"line\">        <span class=\"attr\">\"level\"</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"alterId\"</span>: <span class=\"number\">64</span></span><br><span class=\"line\">      &#125;, &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"uuid2\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"level\"</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"alterId\"</span>: <span class=\"number\">64</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      ],</span><br><span class=\"line\">      <span class=\"attr\">\"detour\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"to\"</span>: <span class=\"string\">\"dynamicPort\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">\"streamSettings\"</span>: &#123; <span class=\"comment\">// 不使用kcp就把streamSettings节点删除掉</span></span><br><span class=\"line\">      <span class=\"attr\">\"network\"</span>: <span class=\"string\">\"kcp\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;, &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"vmess\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"port\"</span>: <span class=\"string\">\"8100-10000\"</span>,  <span class=\"comment\">// 使用8100-10000范围的端口</span></span><br><span class=\"line\">    <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"dynamicPort\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"settings\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"default\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"level\"</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"alterId\"</span>: <span class=\"number\">32</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">\"allocate\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"strategy\"</span>: <span class=\"string\">\"random\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"concurrency\"</span>: <span class=\"number\">2</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"refresh\"</span>: <span class=\"number\">3</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">\"streamSettings\"</span>: &#123; <span class=\"comment\">// 不使用kcp就把streamSettings节点删除掉</span></span><br><span class=\"line\">      <span class=\"attr\">\"network\"</span>: <span class=\"string\">\"kcp\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">\"outbounds\"</span>: [&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"freedom\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"settings\"</span>: &#123;&#125;</span><br><span class=\"line\">  &#125;, &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"blackhole\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"settings\"</span>: &#123;&#125;,</span><br><span class=\"line\">    <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"blocked\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">\"routing\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"rules\"</span>: [&#123;</span><br><span class=\"line\">      <span class=\"attr\">\"type\"</span>: <span class=\"string\">\"field\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"ip\"</span>: [<span class=\"string\">\"geoip:private\"</span>],</span><br><span class=\"line\">      <span class=\"attr\">\"outboundTag\"</span>: <span class=\"string\">\"blocked\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>v2rayN客户端配置：</p>\n<p><img src=\"/2019/05/25/v2ray/config_client_kcp.png\" alt=\"config_client_kcp.png\"></p>\n<h2><span id=\"2websockettlsweb\">2.WebSocket+TLS+Web</span></h2><h3><span id=\"1域名\">1)域名</span></h3><p>使用这套配置需要首先拥有一个域名，不过不用担心要去买域名，有一个网站<a href=\"https://www.freenom.com/en/freeandpaiddomains.html\" target=\"_blank\" rel=\"noopener\">freenom</a>可以免费注册域名，理论最长免费持有一年，到期就要另外付钱了，不过这都不是问题，到时候再换个域名就是了。随便注册一个偏僻的域名后，在管理里面把域名指向V2ray服务器的IP。</p>\n<p><img src=\"/2019/05/25/v2ray/domain_my.png\" alt=\"domain_my.png\"></p>\n<p><img src=\"/2019/05/25/v2ray/domain_manage_dns.png\" alt=\"domain_manage_dns.png\"></p>\n<p>添加新的DNS解析记录：</p>\n<p><img src=\"/2019/05/25/v2ray/domain_new_rule.png\" alt=\"domain_new_rule.png\"></p>\n<h3><span id=\"2tls\">2)TLS</span></h3><p>TLS也有免费的服务，我们使用<a href=\"https://letsencrypt.org/\" target=\"_blank\" rel=\"noopener\">Let’s Encrypt</a>，需要开始在V2ray服务器上执行以下命令：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装依赖</span></span><br><span class=\"line\">sudo apt-get -y install netcat socat</span><br><span class=\"line\"><span class=\"comment\"># 安装脚本</span></span><br><span class=\"line\">curl  https://get.acme.sh | sh</span><br><span class=\"line\"><span class=\"comment\"># 生成证书可以是ec-256 、ec-384、2048、3072、4096、8192,带ec为ecc证书，我们就使用ec证书就行了</span></span><br><span class=\"line\"><span class=\"comment\"># 把下面配置和命令中的yourdomain替换成自己的域名</span></span><br><span class=\"line\">sudo ~/.acme.sh/acme.sh --issue -d yourdomain --standalone -k ec-256</span><br><span class=\"line\"><span class=\"comment\"># 该证书有效期3月,需要定时更新证书,因此需要 90 天至少要更新一次证书，acme.sh 脚本会每 60 天自动更新证书，所以不用担心。</span></span><br><span class=\"line\"><span class=\"comment\"># 也有手动更新的命令</span></span><br><span class=\"line\">sudo ~/.acme.sh/acme.sh --renew -d yourdomain --force --ecc</span><br><span class=\"line\"><span class=\"comment\"># 安装证书</span></span><br><span class=\"line\">sudo ~/.acme.sh/acme.sh --installcert -d yourdomain --fullchainpath /etc/v2ray/v2ray.crt --keypath /etc/v2ray/v2ray.key --ecc</span><br></pre></td></tr></table></figure></p>\n<h3><span id=\"3webnginx\">3)Web(Nginx)</span></h3><p>执行以下命令：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装nginx</span></span><br><span class=\"line\">apt-get install -y nginx</span><br></pre></td></tr></table></figure></p>\n<h3><span id=\"4配置\">4)配置</span></h3><p>替换V2ray服务端的配置：<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"log\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"loglevel\"</span>: <span class=\"string\">\"info\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"access\"</span>: <span class=\"string\">\"/var/log/v2ray/access.log\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"error\"</span>: <span class=\"string\">\"/var/log/v2ray/error.log\"</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">\"inbounds\"</span>: [&#123;</span><br><span class=\"line\">      <span class=\"attr\">\"port\"</span>: <span class=\"number\">10000</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"listen\"</span>: <span class=\"string\">\"127.0.0.1\"</span>, <span class=\"comment\">//只监听 127.0.0.1，避免除本机外的机器探测到开放了 10000 端口</span></span><br><span class=\"line\">      <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"vmess\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"settings\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"clients\"</span>: [&#123;</span><br><span class=\"line\">            <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"id1\"</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"level\"</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"alterId\"</span>: <span class=\"number\">64</span></span><br><span class=\"line\">          &#125;, &#123;</span><br><span class=\"line\">            <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"id2\"</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"level\"</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"alterId\"</span>: <span class=\"number\">64</span></span><br><span class=\"line\">          &#125;, &#123;</span><br><span class=\"line\">            <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"id3\"</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"level\"</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"alterId\"</span>: <span class=\"number\">64</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"attr\">\"streamSettings\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"network\"</span>: <span class=\"string\">\"ws\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"wsSettings\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"attr\">\"path\"</span>: <span class=\"string\">\"/ray\"</span> <span class=\"comment\">//这个path是跟nginx中的配置一致</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">\"outbounds\"</span>: [&#123;</span><br><span class=\"line\">      <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"freedom\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"settings\"</span>: &#123;&#125;</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"blackhole\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"settings\"</span>: &#123;&#125;,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"blocked\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">\"routing\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"rules\"</span>: [&#123;</span><br><span class=\"line\">        <span class=\"attr\">\"type\"</span>: <span class=\"string\">\"field\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"ip\"</span>: [<span class=\"string\">\"geoip:private\"</span>],</span><br><span class=\"line\">        <span class=\"attr\">\"outboundTag\"</span>: <span class=\"string\">\"blocked\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>新建一个nginx的配置文件<code>touch  /etc/nginx/conf.d/v2ray.conf</code>，内容是：<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#v2ray</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span>  <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">  <span class=\"attribute\">ssl</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate</span>       /etc/v2ray/v2ray.crt;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate_key</span>   /etc/v2ray/v2ray.key;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_protocols</span>         TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_ciphers</span>           HIGH:!aNULL:!MD5;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span>           yourdomain;</span><br><span class=\"line\">\t<span class=\"attribute\">location</span> /ray &#123; <span class=\"comment\"># 与 V2Ray 配置中的 path 保持一致</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_redirect</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://127.0.0.1:10000;<span class=\"comment\">#假设WebSocket监听在环回地址的10000端口上</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_http_version</span> <span class=\"number\">1</span>.<span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> Upgrade <span class=\"variable\">$http_upgrade</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> Connection <span class=\"string\">\"upgrade\"</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$http_host</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># Show realip in v2ray access.log</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">        <span class=\"comment\"># proxy_set_header Host $host;</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>v2rayN客户端配置：</p>\n<p><img src=\"/2019/05/25/v2ray/config_client_tls.png\" alt=\"config_client_tls.png\"></p>\n<h3><span id=\"5配置开启数据统计功能\">5)配置(开启数据统计功能)</span></h3><p>我个人使用的时候开启了数据统计的功能，并写了一些脚本方便查看，有需要的可以用下面的配置。</p>\n<p>执行命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装fcgiwrap和jq</span></span><br><span class=\"line\">apt-get install -y fcgiwrap jq</span><br><span class=\"line\"><span class=\"comment\"># 后台启动fcgiwrap</span></span><br><span class=\"line\">nohup fcgiwrap -f -c 4 -s unix:/run/fcgiwrap.socket &lt;/dev/null &amp;&gt;/dev/null &amp;</span><br></pre></td></tr></table></figure>\n<p>V2ray服务配置：<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"log\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"loglevel\"</span>: <span class=\"string\">\"info\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"access\"</span>: <span class=\"string\">\"/var/log/v2ray/access.log\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"error\"</span>: <span class=\"string\">\"/var/log/v2ray/error.log\"</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">\"policy\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"levels\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"1\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"statsUserUplink\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"statsUserDownlink\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">\"system\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"statsInboundUplink\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"statsInboundDownlink\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">\"stats\"</span>: &#123;&#125;,</span><br><span class=\"line\">  <span class=\"attr\">\"api\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"api\"</span>,</span><br><span class=\"line\">    <span class=\"attr\">\"services\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"HandlerService\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"LoggerService\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"StatsService\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">\"inbounds\"</span>: [&#123;</span><br><span class=\"line\">      <span class=\"attr\">\"port\"</span>: <span class=\"number\">10000</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"listen\"</span>: <span class=\"string\">\"127.0.0.1\"</span>, <span class=\"comment\">//只监听 127.0.0.1，避免除本机外的机器探测到开放了 10000 端口</span></span><br><span class=\"line\">      <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"vmess\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"tlsIn\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"settings\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"clients\"</span>: [&#123;</span><br><span class=\"line\">            <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"id1\"</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"level\"</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"alterId\"</span>: <span class=\"number\">64</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"email\"</span>: <span class=\"string\">\"email1\"</span>  <span class=\"comment\">// 统计功能主要是通过这个email来判定，所以必须填，可以不用是email，填一个代号即可，比如这个client的配置我是给Bob的，那我这就填：Bob</span></span><br><span class=\"line\">          &#125;, &#123;</span><br><span class=\"line\">            <span class=\"attr\">\"id\"</span>: <span class=\"string\">\"id2\"</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"level\"</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"alterId\"</span>: <span class=\"number\">64</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"email\"</span>: <span class=\"string\">\"email2\"</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"attr\">\"streamSettings\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"network\"</span>: <span class=\"string\">\"ws\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"wsSettings\"</span>: &#123;</span><br><span class=\"line\">          <span class=\"attr\">\"path\"</span>: <span class=\"string\">\"/ray\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"listen\"</span>: <span class=\"string\">\"127.0.0.1\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"port\"</span>: <span class=\"number\">10085</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"dokodemo-door\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"settings\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"address\"</span>: <span class=\"string\">\"127.0.0.1\"</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"api\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">\"outbounds\"</span>: [&#123;</span><br><span class=\"line\">      <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"freedom\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"settings\"</span>: &#123;&#125;,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"tlsOut\"</span></span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"protocol\"</span>: <span class=\"string\">\"blackhole\"</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"settings\"</span>: &#123;&#125;,</span><br><span class=\"line\">      <span class=\"attr\">\"tag\"</span>: <span class=\"string\">\"blocked\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">\"routing\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"rules\"</span>: [&#123;</span><br><span class=\"line\">        <span class=\"attr\">\"inboundTag\"</span>: [<span class=\"string\">\"api\"</span>],</span><br><span class=\"line\">        <span class=\"attr\">\"outboundTag\"</span>: <span class=\"string\">\"api\"</span>,</span><br><span class=\"line\">        <span class=\"attr\">\"type\"</span>: <span class=\"string\">\"field\"</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">\"strategy\"</span>: <span class=\"string\">\"rules\"</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>新建一个nginx的配置文件<code>touch  /etc/nginx/conf.d/v2ray.conf</code>，内容是：<br><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span>  <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">  <span class=\"attribute\">ssl</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate</span>       /etc/v2ray/v2ray.crt;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_certificate_key</span>   /etc/v2ray/v2ray.key;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_protocols</span>         TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\">  <span class=\"attribute\">ssl_ciphers</span>           HIGH:!aNULL:!MD5;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span>           yourdomain;</span><br><span class=\"line\">    <span class=\"attribute\">location</span> /ray &#123; <span class=\"comment\"># 与 V2Ray 配置中的 path 保持一致</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_redirect</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://127.0.0.1:10000;<span class=\"comment\">#假设WebSocket监听在环回地址的10000端口上</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_http_version</span> <span class=\"number\">1</span>.<span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> Upgrade <span class=\"variable\">$http_upgrade</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> Connection <span class=\"string\">\"upgrade\"</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> Host <span class=\"variable\">$http_host</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># Show realip in v2ray access.log</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">        <span class=\"comment\"># proxy_set_header Host $host;</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ (\\.sh|\\.lua)$</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span> /home/statistics;</span><br><span class=\"line\">        <span class=\"attribute\">include</span> fastcgi_params;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_pass</span> unix:/var/run/fcgiwrap.socket;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_param</span> SCRIPT_FILENAME <span class=\"variable\">$document_root</span><span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_buffers</span> <span class=\"number\">256</span> <span class=\"number\">48k</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_buffer_size</span> <span class=\"number\">48k</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_connect_timeout</span> <span class=\"number\">15s</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_send_timeout</span> <span class=\"number\">15s</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_read_timeout</span> <span class=\"number\">15s</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_busy_buffers_size</span> <span class=\"number\">256k</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_temp_file_write_size</span> <span class=\"number\">256k</span>;</span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_max_temp_file_size</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"attribute\">reset_timedout_connection</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">       <span class=\"comment\"># server_names_hash_bucket_size 100;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"attribute\">location</span> <span class=\"regexp\">~ (\\.txt)$</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span> /home/statistics;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>用来统计数据的脚本(自用)，创建一个文件<code>touch /home/statistics/statistics.sh</code> 内容是：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/usr/bin/env bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#v2ray data statistics</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#inbound tag</span></span><br><span class=\"line\">inbound_tag=$(cat /etc/v2ray/config.json | jq .inbounds[0].tag | xargs <span class=\"built_in\">echo</span>)</span><br><span class=\"line\"><span class=\"comment\">#client.email</span></span><br><span class=\"line\">email_arr=()</span><br><span class=\"line\"></span><br><span class=\"line\">inbound_down_name=<span class=\"string\">\"\\\\\\\"inbound&gt;&gt;&gt;<span class=\"variable\">$inbound_tag</span>&gt;&gt;&gt;traffic&gt;&gt;&gt;downlink\\\\\\\"\"</span></span><br><span class=\"line\">inbound_up_name=<span class=\"string\">\"\\\\\\\"inbound&gt;&gt;&gt;<span class=\"variable\">$inbound_tag</span>&gt;&gt;&gt;traffic&gt;&gt;&gt;uplink\\\\\\\"\"</span></span><br><span class=\"line\">api_cmd=<span class=\"string\">\"/usr/bin/v2ray/v2ctl api --server=127.0.0.1:10085 StatsService.GetStats \\'name: [name] \"</span></span><br><span class=\"line\">handle=<span class=\"string\">\" | grep value | tr -d 'value:' | tr -d ' '\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">statistics_path=<span class=\"string\">'/home/statistics'</span></span><br><span class=\"line\">statistics_file=<span class=\"string\">\"<span class=\"variable\">$&#123;statistics_path&#125;</span>/history.txt\"</span></span><br><span class=\"line\">file_formatter=<span class=\"string\">\"%-20s%-15s%-15s\\n\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">header=<span class=\"string\">'Users Download Upload'</span></span><br><span class=\"line\">total=<span class=\"string\">'Total'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">readEmail</span></span>() &#123;</span><br><span class=\"line\">  tmp=$(cat /etc/v2ray/config.json | jq .inbounds[0].settings.clients[].email | xargs <span class=\"built_in\">echo</span>)</span><br><span class=\"line\">  <span class=\"built_in\">readarray</span> -d <span class=\"string\">' '</span> -t email_arr &lt;&lt;&lt;<span class=\"string\">\"<span class=\"variable\">$tmp</span>\"</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"string\">\"<span class=\"variable\">$&#123;!email_arr[@]&#125;</span>\"</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">    email_arr[<span class=\"variable\">$i</span>]=$(<span class=\"built_in\">echo</span> <span class=\"variable\">$&#123;email_arr[$i]&#125;</span> | tr -d <span class=\"string\">' '</span>)</span><br><span class=\"line\">  <span class=\"keyword\">done</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">buildCmd</span></span>() &#123;</span><br><span class=\"line\">  result=<span class=\"string\">\"echo <span class=\"variable\">$base_cmd</span> | sed \\\"s/\\[name\\]/<span class=\"variable\">$1</span>/g\\\"\"</span></span><br><span class=\"line\">  <span class=\"built_in\">eval</span> <span class=\"variable\">$&#123;result&#125;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">doStats</span></span>() &#123;</span><br><span class=\"line\">  buildCmd=$(buildCmd <span class=\"variable\">$1</span>)</span><br><span class=\"line\">  cmd=<span class=\"string\">\"<span class=\"variable\">$buildCmd</span> <span class=\"variable\">$handle</span>\"</span></span><br><span class=\"line\">  <span class=\"built_in\">eval</span> <span class=\"variable\">$&#123;cmd&#125;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">statsHistory</span></span>() &#123;</span><br><span class=\"line\">  user=<span class=\"variable\">$total</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"variable\">$1</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    user=<span class=\"variable\">$1</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  handle_history=<span class=\"string\">\"cat <span class=\"variable\">$&#123;statistics_path&#125;</span>/history.txt | grep <span class=\"variable\">$user</span> | xargs -n3 | awk '&#123;\\$1=\\\"\\\";print \\$0&#125;' | sed '/0.000B/d' | xargs -n2 | numfmt --from=iec-i --suffix=B --field 1-2 | tr -d B | awk '&#123;up+=\\$1;down+=\\$2&#125; END &#123;printf(\\\"%f %d\\n\\\", up, down)&#125;' | numfmt --to=iec-i --suffix=B --field 1-2\"</span></span><br><span class=\"line\">  <span class=\"built_in\">eval</span> <span class=\"variable\">$&#123;handle_history&#125;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">format</span></span>() &#123;</span><br><span class=\"line\">  num=0</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"variable\">$1</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    num=<span class=\"variable\">$1</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  fmtCmd=<span class=\"string\">\"numfmt --to=iec-i --suffix=B --padding=7 --format %5.3f <span class=\"variable\">$num</span>\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> $(<span class=\"variable\">$&#123;fmtCmd&#125;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">appendFile</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span> <span class=\"variable\">$&#123;file_formatter&#125;</span> <span class=\"variable\">$@</span> &gt;&gt;<span class=\"variable\">$&#123;statistics_file&#125;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">appendSto</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"built_in\">printf</span> <span class=\"variable\">$&#123;file_formatter&#125;</span> <span class=\"variable\">$@</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">now</span></span>() &#123;</span><br><span class=\"line\">  <span class=\"built_in\">eval</span> <span class=\"string\">'TZ=Asia/Shanghai date \"+%Y-%m-%d/%H:%M:%S %a\"'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">printHtml</span></span>() &#123;</span><br><span class=\"line\">  NAME=<span class=\"string\">\"USAGE\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> -e <span class=\"string\">\"X-Test-Author: Michael\\r\\n\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"&lt;html&gt;&lt;head&gt;\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"&lt;title&gt;<span class=\"variable\">$NAME</span>&lt;/title&gt;\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'&lt;meta name=\"description\" content=\"'</span><span class=\"variable\">$NAME</span><span class=\"string\">'\"&gt;'</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'&lt;meta name=\"keywords\" content=\"'</span><span class=\"variable\">$NAME</span><span class=\"string\">'\"&gt;'</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'&lt;meta http-equiv=\"Content-type\" content=\"text/html; charset=UTF-8\"&gt;'</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">'&lt;meta name=\"ROBOTS\" content=\"noindex\"&gt;'</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"&lt;/head&gt;&lt;body&gt;&lt;pre&gt;\"</span></span><br><span class=\"line\">  appendSto $(now)</span><br><span class=\"line\">  appendSto <span class=\"variable\">$header</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"string\">\"<span class=\"variable\">$&#123;!email_arr[@]&#125;</span>\"</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">    appendSto <span class=\"variable\">$&#123;email_arr[$i]&#125;</span> <span class=\"variable\">$&#123;userDownData_arr[$i]&#125;</span> <span class=\"variable\">$&#123;userUpData_arr[$i]&#125;</span></span><br><span class=\"line\">  <span class=\"keyword\">done</span></span><br><span class=\"line\">  appendSto <span class=\"string\">\"<span class=\"variable\">$total</span> <span class=\"variable\">$&#123;inboundDownData&#125;</span> <span class=\"variable\">$&#123;inboundUpData&#125;</span>\"</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">\"&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">printFile</span></span>() &#123;</span><br><span class=\"line\">  dateNow=$(TZ=Asia/Shanghai date <span class=\"string\">\"+%d\"</span>)</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"variable\">$&#123;dateNow&#125;</span> == <span class=\"string\">'01'</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    lastMonth=$(TZ=Asia/Shanghai date -d <span class=\"string\">\"<span class=\"variable\">$(date +%Y%m)</span>01 last month\"</span> +%Y-%m)</span><br><span class=\"line\">    appendFile <span class=\"variable\">$lastMonth</span></span><br><span class=\"line\">    appendFile <span class=\"variable\">$header</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"string\">\"<span class=\"variable\">$&#123;!email_arr[@]&#125;</span>\"</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">      result=$(statsHistory <span class=\"variable\">$&#123;email_arr[$i]&#125;</span>)</span><br><span class=\"line\">      appendFile <span class=\"variable\">$&#123;email_arr[$i]&#125;</span> <span class=\"variable\">$result</span></span><br><span class=\"line\">    <span class=\"keyword\">done</span></span><br><span class=\"line\">    result=$(statsHistory)</span><br><span class=\"line\">    appendFile <span class=\"variable\">$total</span> <span class=\"variable\">$result</span></span><br><span class=\"line\">    mv <span class=\"variable\">$&#123;statistics_file&#125;</span> <span class=\"string\">\"<span class=\"variable\">$&#123;statistics_path&#125;</span>/history-<span class=\"variable\">$&#123;lastMonth&#125;</span>.txt\"</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  appendFile $(now)</span><br><span class=\"line\">  appendFile <span class=\"variable\">$header</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"string\">\"<span class=\"variable\">$&#123;!email_arr[@]&#125;</span>\"</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">    appendFile <span class=\"variable\">$&#123;email_arr[$i]&#125;</span> <span class=\"variable\">$&#123;userDownData_arr[$i]&#125;</span> <span class=\"variable\">$&#123;userUpData_arr[$i]&#125;</span></span><br><span class=\"line\">  <span class=\"keyword\">done</span></span><br><span class=\"line\">  appendFile <span class=\"string\">\"<span class=\"variable\">$total</span> <span class=\"variable\">$&#123;inboundDownData&#125;</span> <span class=\"variable\">$&#123;inboundUpData&#125;</span>\"</span></span><br><span class=\"line\">  appendFile <span class=\"string\">\"-------------------- --------------- ---------------\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"variable\">$#</span> == 1 ]] &amp;&amp; [[ <span class=\"variable\">$1</span> == <span class=\"string\">'-f'</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  base_cmd=<span class=\"string\">\"<span class=\"variable\">$api_cmd</span> reset: true\\'\"</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  base_cmd=<span class=\"string\">\"<span class=\"variable\">$api_cmd</span> reset: false\\'\"</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">inboundDownBytes=$(doStats <span class=\"variable\">$&#123;inbound_down_name&#125;</span>)</span><br><span class=\"line\">inboundDownData=$(format <span class=\"variable\">$&#123;inboundDownBytes&#125;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">inboundUpBytes=$(doStats <span class=\"variable\">$&#123;inbound_up_name&#125;</span>)</span><br><span class=\"line\">inboundUpData=$(format <span class=\"variable\">$&#123;inboundUpBytes&#125;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">userDownData_arr=()</span><br><span class=\"line\">userUpData_arr=()</span><br><span class=\"line\"></span><br><span class=\"line\">readEmail</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"string\">\"<span class=\"variable\">$&#123;!email_arr[@]&#125;</span>\"</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">  email=<span class=\"variable\">$&#123;email_arr[$i]&#125;</span></span><br><span class=\"line\">  user_down_name=<span class=\"string\">\"\\\\\\\"user&gt;&gt;&gt;<span class=\"variable\">$email</span>&gt;&gt;&gt;traffic&gt;&gt;&gt;downlink\\\\\\\"\"</span></span><br><span class=\"line\">  user_up_name=<span class=\"string\">\"\\\\\\\"user&gt;&gt;&gt;<span class=\"variable\">$email</span>&gt;&gt;&gt;traffic&gt;&gt;&gt;uplink\\\\\\\"\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">  userDownBytes=$(doStats <span class=\"variable\">$&#123;user_down_name&#125;</span>)</span><br><span class=\"line\">  userDownData_arr[<span class=\"variable\">$i</span>]=$(format <span class=\"variable\">$&#123;userDownBytes&#125;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">  userUpBytes=$(doStats <span class=\"variable\">$&#123;user_up_name&#125;</span>)</span><br><span class=\"line\">  userUpData_arr[<span class=\"variable\">$i</span>]=$(format <span class=\"variable\">$&#123;userUpBytes&#125;</span>)</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"variable\">$#</span> == 1 ]] &amp;&amp; [[ <span class=\"variable\">$1</span> == <span class=\"string\">'-f'</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  printFile</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  printHtml</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure></p>\n<p>添加crontab任务每天晚上自动统计当天流量并写入文件记录下来：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -e</span><br><span class=\"line\"><span class=\"comment\"># 输入下面的内容</span></span><br><span class=\"line\">0 0 * * * /home/statistics/statistics.sh -f</span><br><span class=\"line\"><span class=\"comment\"># 添加执行权限</span></span><br><span class=\"line\">chmod +x /home/statistics/statistics.sh</span><br></pre></td></tr></table></figure></p>\n<p>这样就可以通过浏览器访问，查看流量的使用情况了，使用情况就是根据配置<code>inbounds.settings.client.email</code>的值来显示的，所以配置的时候可以配置个容易辨识的值。</p>\n<p>当天流量使用情况，地址： https://你的域名/statistics.sh：</p>\n<p><img src=\"/2019/05/25/v2ray/data_usage.png\" alt=\"data_usage.png\"></p>\n<p>历史记录，地址： https://你的域名/history.txt：</p>\n<p><img src=\"/2019/05/25/v2ray/data_history.png\" alt=\"data_history.png\"></p>\n<h1><span id=\"五-命令\">五、命令</span></h1><p>v2ray服务：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启动V2ray服务</span></span><br><span class=\"line\">systemctl start v2ray</span><br><span class=\"line\"><span class=\"comment\"># 停止V2ray服务</span></span><br><span class=\"line\">systemctl stop v2ray</span><br><span class=\"line\"><span class=\"comment\"># 重启V2ray服务 每次修改了v2ray的配置文件都需要重启</span></span><br><span class=\"line\">systemctl restart v2ray</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证配置是否合法 修改完配置以后在重启服务前可以执行这个命令来看看配置是不是合法的</span></span><br><span class=\"line\">v2ray -<span class=\"built_in\">test</span> -config /etc/v2ray/config.json</span><br></pre></td></tr></table></figure></p>\n<p>nginx：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 测试nginx配置文件是否有效 修改了nginx配置后可以使用这个命令来验证</span></span><br><span class=\"line\">nginx -t</span><br><span class=\"line\"><span class=\"comment\"># 重载配置文件，让修改了的配置文件生效，这样就不需要重启nginx服务了</span></span><br><span class=\"line\">nginx -s reload</span><br></pre></td></tr></table></figure></p>\n","tags":[{"name":"Tools","slug":"Tools","permalink":"http://yoursite.com/tags/Tools/"},{"name":"V2ray","slug":"V2ray","permalink":"http://yoursite.com/tags/V2ray/"}]},{"title":"利用Github pages快速搭建博客","date":"2019-05-19T02:03:36.000Z","path":"2019/05/19/blog/","content":"<h1><span id=\"一-前言\">一、前言</span></h1><p>每次当我想要自己搭建一个博客时，总是被麻烦的服务器配置维护、服务搭建和后续的维护所劝退，但现在利用github pages搭建个人博客越来越流行，而且搭建、使用和管理都十分方便快捷，正好完成这个夙愿。。。</p>\n<a id=\"more\"></a>\n<h1><span id=\"二-准备\">二、准备</span></h1><h2><span id=\"1github\">1.github</span></h2><p>作为一个程序猿，github应该是每个猿必不可少的，先创建一个repo用来存放编译好的静态博客页面，repo的name格式为<code>username.github.io</code>，即你的github的username。</p>\n<p><img src=\"/2019/05/19/blog/github-pages-repo.png\" alt=\"新建repo\"></p>\n<p>进入这个新的repo的setting，拉到下面的Github Pages，随便选一个主题</p>\n<p><img src=\"/2019/05/19/blog/github-pages-theme.png\" alt=\"修改主题\"></p>\n<p>确定本地已经在github中添加了ssh key了，如果没有添加：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 输入命令，然后按3次回车</span></span><br><span class=\"line\">ssh-keygen -t rsa -C <span class=\"string\">\"your email\"</span></span><br><span class=\"line\"><span class=\"comment\"># 查看生成的公钥 </span></span><br><span class=\"line\">cat ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure></p>\n<p>复制内容，粘贴到github个人设置中的添加新的<a href=\"https://github.com/settings/keys\" target=\"_blank\" rel=\"noopener\">SSH key</a></p>\n<h2><span id=\"2本地环境\">2.本地环境</span></h2><p>需要安装Node JS和Git，后面的命令都运行在git bash中。使用<a href=\"https://hexo.io/zh-cn/index.html\" target=\"_blank\" rel=\"noopener\">hexo</a>框架来快速搭建，这个框架很强大而且支持各种主题，也有很多大神开发了自己的主题。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装hexo</span></span><br><span class=\"line\">npm install hexo-cli -g</span><br><span class=\"line\"><span class=\"comment\"># 初始化一个新的hexo博客项目，这里面存放的是博客的源码,folder就是你项目的文件夹名，例如：blog</span></span><br><span class=\"line\"><span class=\"comment\"># 下面就以blog作为文件夹名</span></span><br><span class=\"line\"><span class=\"comment\"># hexo init &lt;folder&gt;</span></span><br><span class=\"line\">hexo init blog</span><br><span class=\"line\"><span class=\"built_in\">cd</span> blog</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">项目目录结构如下  </span><br><span class=\"line\">├── _config.yml   <span class=\"comment\"># 项目配置文件</span></span><br><span class=\"line\">├── package.json  <span class=\"comment\"># 依赖包</span></span><br><span class=\"line\">├── scaffolds     <span class=\"comment\"># 模板</span></span><br><span class=\"line\">├── <span class=\"built_in\">source</span>        <span class=\"comment\"># 用户资源</span></span><br><span class=\"line\">|   ├── _drafts   <span class=\"comment\"># 草稿</span></span><br><span class=\"line\">|   └── _posts    <span class=\"comment\"># 博文</span></span><br><span class=\"line\">└── themes        <span class=\"comment\"># 主题</span></span><br></pre></td></tr></table></figure>\n<h1><span id=\"三-搭建\">三、搭建</span></h1><p>修改<code>package.json</code>，将<code>dependencies</code>节点替换掉：<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"hexo\"</span>: <span class=\"string\">\"^3.2.0\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-asset-image\"</span>: <span class=\"string\">\"git+https://github.com/CodeFalling/hexo-asset-image.git\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-deployer-git\"</span>: <span class=\"string\">\"^1.0.0\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-generator-archive\"</span>: <span class=\"string\">\"^0.1.4\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-generator-baidu-sitemap\"</span>: <span class=\"string\">\"^0.1.2\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-generator-category\"</span>: <span class=\"string\">\"^0.1.3\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-generator-index\"</span>: <span class=\"string\">\"^0.2.0\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-generator-json-content\"</span>: <span class=\"string\">\"^3.0.1\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-generator-json-feed\"</span>: <span class=\"string\">\"^1.0.0\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-generator-seo-friendly-sitemap\"</span>: <span class=\"string\">\"0.0.20\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-generator-sitemap\"</span>: <span class=\"string\">\"^1.1.2\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-generator-tag\"</span>: <span class=\"string\">\"^0.2.0\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-helper-qrcode\"</span>: <span class=\"string\">\"^1.0.1\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-renderer-ejs\"</span>: <span class=\"string\">\"^0.3.1\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-renderer-markdown-it\"</span>: <span class=\"string\">\"^3.4.1\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-renderer-marked\"</span>: <span class=\"string\">\"^0.2.5\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-renderer-stylus\"</span>: <span class=\"string\">\"^0.3.1\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-server\"</span>: <span class=\"string\">\"^0.2.0\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"hexo-toc\"</span>: <span class=\"string\">\"^1.1.0\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>修改<code>_config.yml</code>，文件最后修改为：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Deployment</span></span><br><span class=\"line\"><span class=\"comment\">## Docs: https://hexo.io/docs/deployment.html</span></span><br><span class=\"line\"><span class=\"attr\">deploy:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">git</span></span><br><span class=\"line\">  <span class=\"attr\">repo:</span> <span class=\"string\">git@github.com:&lt;Github账号名称&gt;/&lt;Github账号名称&gt;.github.io.git</span></span><br><span class=\"line\">  <span class=\"attr\">branch:</span> <span class=\"string\">master</span></span><br></pre></td></tr></table></figure></p>\n<p>安装依赖并启动服务：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install</span><br><span class=\"line\"><span class=\"comment\"># 在本地启动服务，访问 http://localhost:4000 ，一个新的博客就起起来了</span></span><br><span class=\"line\">hexo s</span><br><span class=\"line\"><span class=\"comment\">## 其他命令</span></span><br><span class=\"line\"><span class=\"comment\"># 生成静态文件</span></span><br><span class=\"line\">hexo g</span><br><span class=\"line\"><span class=\"comment\"># 部署到github pages</span></span><br><span class=\"line\">hexo d</span><br><span class=\"line\"><span class=\"comment\"># 清除生成的静态文件</span></span><br><span class=\"line\">hexo clean</span><br></pre></td></tr></table></figure></p>\n<h1><span id=\"四-主题\">四、主题</span></h1><p>hexo的主题很多，安装好hexo后也会有默认的主题landscape，但是我还是比较喜欢<a href=\"https://github.com/litten/hexo-theme-yilia\" target=\"_blank\" rel=\"noopener\">yilia</a>这个主题<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/litten/hexo-theme-yilia.git themes/yilia</span><br></pre></td></tr></table></figure></p>\n<p>修改项目配置文件<code>_config.yml</code>中的theme，改成：<code>theme: yilia</code></p>\n<p>主题的配置文件在<code>theme/yilia/_config.yml</code>，要根据实际情况和自己的喜好配置，每个配置项都有详细的中文说明。</p>\n<h2><span id=\"1评论\">1.评论</span></h2><p>博客必不可少的评论功能当然要开启啦，yilia主题可以帮我们快速开启评论功能，只需要简单的配置。</p>\n<h3><span id=\"1gitalk\">1)gitalk</span></h3><p>yilia主题内置的<a href=\"https://github.com/imsun/gitment\" target=\"_blank\" rel=\"noopener\">gitment</a>目前已经不更新了，而且使用起来有点问题，所以使用<a href=\"https://github.com/gitalk/gitalk\" target=\"_blank\" rel=\"noopener\">gitalk</a>。具体配置参见<a href=\"https://ziven.cc/2018/07/03/Hexo%E4%B8%BB%E9%A2%98yilia%E5%A2%9E%E5%8A%A0gitalk%E8%AF%84%E8%AE%BA%E6%8F%92%E4%BB%B6/\" target=\"_blank\" rel=\"noopener\">Hexo主题yilia增加gitalk评论插件</a></p>\n<h3><span id=\"2畅言\">2)畅言</span></h3><p><a href=\"http://changyan.kuaizhan.com\" target=\"_blank\" rel=\"noopener\">畅言</a>是yilia主题内置的，配置简单，但是需要先去注册一个账号，注册完账号后需要在里面注册一个新的网站，其他的都好说，主要是需要填入网站的备案号，我们一般的小博客网站怎么可能有备案号，更别说我们用的是github的网站。但也是有解决办法的。</p>\n<p>随便找一个已经有备案号的网址填入，如果不知道网址的备案号，可以使用<a href=\"https://icp.chinaz.com/\" target=\"_blank\" rel=\"noopener\">站长工具</a>搜索一个，比如。</p>\n<p><img src=\"/2019/05/19/blog/sit_info.png\" alt=\"搜索站点信息\"><br>然后就可以像这样填入审核信息了。</p>\n<p><img src=\"/2019/05/19/blog/changyan_info.png\" alt=\"畅言网站信息\"></p>\n<p>注意在网站白名单中加入自己的github pages的地址就行了。这样就可以提交审核了，应该很快就可以通过，然后就可以畅言的后台总览下面找到自己的<code>app id</code>和<code>app key</code>了。</p>\n<p><img src=\"/2019/05/19/blog/changyan_secret.png\" alt=\"配置信息\"><br>修改主题的配置文件<code>theme/yilia/_config.yml</code>：<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">changyan_appid:</span> <span class=\"string\">'你的app id'</span></span><br><span class=\"line\"><span class=\"attr\">changyan_conf:</span> <span class=\"string\">'你的app key'</span></span><br></pre></td></tr></table></figure></p>\n<p>这样畅言评论就可以使用了</p>\n<p><img src=\"/2019/05/19/blog/changyan_comment.png\" alt=\"畅言评论\"><br>但是还有个问题，没有ADBlock这种神器的情况下，右下角会弹出广告！！！ 有办法，修改<code>themes/yilia/source/main.0cf68a.css</code>，在最后面添加一行：<br><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-id\">#feedAv</span> &#123; <span class=\"attribute\">margin-top</span>: -<span class=\"number\">250px</span><span class=\"meta\">!important</span>; <span class=\"attribute\">transform</span>: <span class=\"built_in\">scale</span>(<span class=\"number\">0</span>)<span class=\"meta\">!important</span>; <span class=\"attribute\">z-index</span>: -<span class=\"number\">999</span><span class=\"meta\">!important</span>; &#125; <span class=\"selector-id\">#pop_ad</span> &#123; <span class=\"attribute\">margin-top</span>: -<span class=\"number\">250px</span><span class=\"meta\">!important</span>; <span class=\"attribute\">transform</span>: <span class=\"built_in\">scale</span>(<span class=\"number\">0</span>)<span class=\"meta\">!important</span>; <span class=\"attribute\">z-index</span>: -<span class=\"number\">999</span><span class=\"meta\">!important</span>; &#125;</span><br></pre></td></tr></table></figure></p>\n<h2><span id=\"2访问量统计\">2.访问量统计</span></h2><p>我们使用<a href=\"http://busuanzi.ibruce.info/\" target=\"_blank\" rel=\"noopener\">不蒜子</a>的统计功能，简单快捷。</p>\n<p>修改<code>themes/yilia/layout/_partial/footer.ejs</code>以添加站点统计，添加代码：<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">calss</span>=<span class=\"string\">\"count-span\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">id</span>=<span class=\"string\">\"busuanzi_container_site_pv\"</span>&gt;</span></span><br><span class=\"line\">        总访问量: <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">id</span>=<span class=\"string\">\"busuanzi_value_site_pv\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span>|</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">id</span>=<span class=\"string\">\"busuanzi_container_site_uv\"</span>&gt;</span></span><br><span class=\"line\">        总访客: <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">id</span>=<span class=\"string\">\"busuanzi_value_site_uv\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">async</span> <span class=\"attr\">src</span>=<span class=\"string\">\"//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>我修改后的代码：</p>\n<p><img src=\"/2019/05/19/blog/count_footer.png\" alt=\"footer修改示例\"></p>\n<p>效果如下:</p>\n<p><img src=\"/2019/05/19/blog/footer_example.png\" alt=\"站点统计效果\"></p>\n<p>修改<code>themes/yilia/layout/_partial/article.ejs</code>以添加文章阅读量统计，添加代码：<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">%</span> <span class=\"attr\">if</span> (!<span class=\"attr\">index</span>)&#123; %&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">id</span>=<span class=\"string\">\"busuanzi_container_page_pv\"</span>&gt;</span></span><br><span class=\"line\">|阅读量(<span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">id</span>=<span class=\"string\">\"busuanzi_value_page_pv\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span>)</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">%</span> &#125; %&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>加在<code>&lt;%- partial(&#39;post/category&#39;) %&gt;</code>后面一行，我修改后的代码：</p>\n<p><img src=\"/2019/05/19/blog/count_article.png\" alt=\"article修改示例\"></p>\n<p>效果如下:</p>\n<p><img src=\"/2019/05/19/blog/article_example.png\" alt=\"阅读量统计效果\"></p>\n<h2><span id=\"3目录\">3.目录</span></h2><p>主题自带目录，只需配置<code>theme/yilia/_config.yml</code>里的<code>toc</code>属性，不过自带的目录不支持移动端显示，所以自定义一下目录，参考<a href=\"http://lawlite.me/2017/04/17/Hexo-yilia%E4%B8%BB%E9%A2%98%E5%AE%9E%E7%8E%B0%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95%E5%92%8C%E6%B7%BB%E5%8A%A0%E8%A7%86%E9%A2%91/\" target=\"_blank\" rel=\"noopener\">Hexo-yilia主题实现文章目录和添加视频</a>这一博文。</p>\n<p>还需要移除主题自带的目录样式，修改<code>themes/yilia/layout/_partial/aside.ejs</code>，删除这些代码：</p>\n<p><img src=\"/2019/05/19/blog/builtin_catalogue_remove.png\" alt=\"builtin_catalogue_remove.png\"></p>\n<p>然而还是发现一个问题，点击目录无法跳转到相应的锚点，经过一番搜索参考<a href=\"http://convivae.top/2019/03/29/Hexo%20%E5%8D%9A%E5%AE%A2%E8%B8%A9%E5%9D%91/#%E6%96%B9%E6%B3%95-2\" target=\"_blank\" rel=\"noopener\">Hexo-博客踩坑</a>这篇博文，成功解决。</p>\n<h1><span id=\"五-写作\">五、写作</span></h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 一个新的草稿，title就是你这边博客的标题，草稿的目录在 source/_draft/&lt;title&gt;.md</span></span><br><span class=\"line\">hexo new draft title</span><br><span class=\"line\"><span class=\"comment\"># 将草稿正式发布，正式的博文在 source/_post/&lt;title&gt;.md</span></span><br><span class=\"line\">hexo publish post title</span><br><span class=\"line\"><span class=\"comment\"># 直接开始一个新的博文</span></span><br><span class=\"line\">hexo new post title</span><br></pre></td></tr></table></figure>\n<h2><span id=\"1博文中引入图片\">1.博文中引入图片</span></h2><p>修改项目配置_config.yml： <code>post_asset_folder: true</code></p>\n<p>_开启这个配置会在开一个新博文的同时在_post目录下生成与博文title同名的文件夹，这个文件夹下可以存在该博文引用的图片资源，这样很方便与管理和使用。</p>\n<p>引用一个图片的格式：<code>![图片标题](博文资源文件夹/图片名)</code></p>\n<p>例如我有一个博文title是 introduction,要引用我的头像,将avatar.png放在博文introduction.md同级的资源目录introduction下：<br><code>![头像](introduction/avatar.png)</code></p>\n<h2><span id=\"2博文首页截断\">2.博文首页截断</span></h2><p>当写完一篇博文在本地启动服务查看效果的时候，发现首页展示了全部的博文内容，应该是只展示开始部分的内容，点击展开全文才进入详情能看到所有的内容。</p>\n<p>原来主题配置文件<code>theme/yilia/_config.yml</code>中有这个配置：<code>excerpt_link: more</code>，需要你自己决定要在什么位置截断，只需要在那个位置加入<code>&lt;!-- more --&gt;</code>，这样首页就会只展示到含有<code>&lt;!-- more --&gt;</code>的位置。</p>\n<p><img src=\"/2019/05/19/blog/index_more.png\" alt=\"more\"></p>\n<p>当然，也有不喜欢more这个链接样式的，也可以将原来的<code>excerpt_link: more</code>改为<code>excerpt_link: false</code>，这样在需要截断的地方还是插入<code>&lt;!-- more --&gt;</code>就可以了，这样就没有more这个链接了。</p>\n<p><img src=\"/2019/05/19/blog/index_no_more.png\" alt=\"no more\"></p>\n<h2><span id=\"3编辑器\">3.编辑器</span></h2><p><a href=\"https://typora.io\" target=\"_blank\" rel=\"noopener\">Typora</a>这个编辑器十分强大，就写markdown而言，个人感觉是很舒适的，它可以让你像是在写word一样写markdown，不用记住markdown的语法就可以写出漂亮的文章，真正的所见即所得。</p>\n<h2><span id=\"4博文项目源码管理\">4.博文项目源码管理</span></h2><p>博文源码项目当然也要用github管理起来，在github上新开一个repo可以就叫blog用来存放这个项目。具体的步骤不再赘述。注意的是需要将<code>theme/yilia</code>下的<code>.git</code>文件夹删除，不然在git pull时会存在<code>Can\\&#39;t update: no tracked branch</code>这样的错误。</p>\n","tags":[{"name":"Github","slug":"Github","permalink":"http://yoursite.com/tags/Github/"},{"name":"Blog","slug":"Blog","permalink":"http://yoursite.com/tags/Blog/"}]}]